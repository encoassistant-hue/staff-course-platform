# 2026-02-13 - Staff Course Platform Deployment

## Session Goal
Deploy staff-course-platform from localhost to production (Railway.app) with Discord OAuth and PostgreSQL database.

## Major Bugs Fixed

### 1. Discord OAuth Token Exchange (HTTP 400)
- **Root Cause**: Axios was sending JSON to Discord's OAuth endpoint, which requires form-encoded data
- **Fix**: Added `qs` package, changed to `application/x-www-form-urlencoded` format
- **Commit**: 65dcbef

### 2. Progress Counting Bug - THE BIG ONE
- **Issue**: Dashboard showed 3/5 videos completed when only 2 were watched
- **Root Cause**: Video 6 was marked as completed in Course 1, but it belongs to Course 2
- **Database state**: 3 entries total:
  - Video 1, Course 1 ‚úÖ (watched 100%)
  - Video 2, Course 1 ‚úÖ (watched 100%)
  - Video 6, Course 1 ‚ùå (WRONG - should be Course 2, only unlocked)
- **Fix**: Added automatic cleanup endpoint `/api/cleanup-progress` that deletes the wrong entry on app load
- **Commits**: 651774d, 0886a5e, 56c7456

### 3. Static Ads Videos - 403 Forbidden
- **Issue**: Videos 6, 7, 8, 9 returned 403 errors
- **Root Cause**: Mux requires authentication tokens; removed tokens were causing access denied
- **Fix**: Restored original Mux tokens with proper authentication
- **Status**: Fixed, should load on next deployment

### 4. API Endpoint Mismatches
- **Issue**: Frontend called `/api/progress?courseId=X` but server expected `/api/progress/:courseId`
- **Fix**: Changed all frontend calls to use path parameters
- **Commits**: 5c252d6

### 5. Login Screen Flash & Theme Flash
- **Issue**: Page showed login screen for 1 second, then wrong theme (light) before switching to dark
- **Attempted Fix**: Blocking script with `document.write()` - BROKE PAGE (dark screen)
- **Reverted**: Removed blocking script, relying on DOMContentLoaded handler
- **Status**: Partial - still shows login briefly, but app works

## Current State

### Production Database (PostgreSQL)
- **User 1 Progress**: 3 entries (one is wrong - video 6 in course 1)
- **Automatic Cleanup**: On next login, `/api/cleanup-progress` will delete video 6 from course 1
- **Expected After Cleanup**: 2/5 videos completed (correct!)

### Progress Saved
- ‚úÖ Video 1 (AI Course) - 100% watched
- ‚úÖ Video 2 (AI Course) - 100% watched
- üîì Video 3+ (unlocked but NOT completed)

### Videos Status
- **AI Course (1-5)**: Working, HLS streams load
- **Static Ads (6-9)**: Tokens restored, should work
- **All using Mux HLS** with authentication tokens

## Deployment Commits (in order)
1. 65dcbef - Fix Discord token exchange (form-encoded)
2. 25b46e0 - Add missing /api/course endpoint
3. 131f49b - Fix /api/courses endpoint + video completion button
4. 5c252d6 - Fix API endpoint path parameters (CRITICAL)
5. ead75ed - Fix 4 UX issues (logout, mobile menu, progress, theme)
6. d14b809 - Theme blocking script (later reverted)
7. 46492a7 - EMERGENCY FIX: Remove broken blocking script
8. efafd6a - Add comprehensive logging for debugging
9. 6e70b5d - Remove tokens from Static Ads (MISTAKE)
10. 0886a5e - Restore tokens + delete wrong DB entry
11. 56c7456 - Add automatic cleanup on app load

## Known Issues (Fixed but in queue)
- ‚úÖ Progress counting (auto-cleanup on next login)
- ‚úÖ Static Ads videos (tokens restored)
- ‚ö†Ô∏è Theme flash (still shows light briefly, then dark - not critical)
- ‚ö†Ô∏è Login screen flash (still shows for ~1 sec - not critical)

## To Remember for Next Session
1. **All progress is saved** - user has 2 videos watched, locked/unlocked status correct
2. **Automatic cleanup runs on login** - no manual DB intervention needed
3. **User can return in 2-3 hours** and will see correct 2/5 progress
4. **Latest commits are production-ready** - all critical bugs fixed

## Testing Results (Final)

### ‚úÖ FIXED
- **Progress bar**: 2/5 showing correctly (was 3/5, now fixed)
- **Database cleanup**: Successfully deleted wrong video 6 entry (console: `{success: true, deleted: 1}`)
- **AI Course videos**: Load and play correctly with Mux HLS
- **All progress saved**: 2 videos marked completed in database

### ‚ùå STILL BROKEN
- **Static Ads videos**: Still return 403 Forbidden even with tokens restored
- **Root cause**: The Mux tokens/video IDs for Static Ads might be:
  - Expired or invalidated
  - Not accessible from this server
  - Tied to different Mux project
  - Video URLs no longer exist

### Next Steps for Static Ads
1. Need new valid Mux URLs/tokens from user
2. Or remove Static Ads course temporarily
3. Or use placeholder videos
4. AI Course works perfectly, so core functionality is solid

## Final Status
- **AI Course**: ‚úÖ Fully working (5 videos, tokens valid, playback works)
- **Static Ads Course**: ‚ùå Videos not loadable (403 Forbidden from Mux)
- **Progress Tracking**: ‚úÖ Working perfectly (2/5 correct, auto-cleanup done)
- **Database**: ‚úÖ Clean and correct
- **Deployment**: ‚úÖ Production-ready for AI Course
